name: Preview Environment

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - "applications/**"

concurrency:
  group: preview-${{ github.head_ref }}
  cancel-in-progress: true

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      markdown-editor: ${{ steps.filter.outputs.markdown-editor }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            markdown-editor:
              - 'applications/atomsized/markdown-editor/**'

  build-markdown-editor:
    needs: detect-changes
    if: needs.detect-changes.outputs.markdown-editor == 'true'
    uses: ./.github/workflows/build-and-push.yml
    with:
      app-path: applications/atomsized/markdown-editor
      image-name: markdown-editor
      tag: pr-${{ github.event.pull_request.number }}
    secrets: inherit

  setup-preview-schema:
    needs: detect-changes
    if: needs.detect-changes.outputs.markdown-editor == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install dependencies
        working-directory: applications/atomsized/markdown-editor
        run: npm ci

      - name: Generate migrations
        working-directory: applications/atomsized/markdown-editor
        run: npm run db:generate
        env:
          DATABASE_URL: ${{ secrets.SUPABASE_DATABASE_URL }}

      - name: Create schema and run migrations
        working-directory: applications/atomsized/markdown-editor
        run: npm run db:migrate
        env:
          DATABASE_URL: ${{ secrets.SUPABASE_DATABASE_URL }}
          DATABASE_SCHEMA: preview_${{ github.head_ref }}

  deploy-preview:
    needs: [build-markdown-editor, setup-preview-schema]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Create preview environment
        env:
          BRANCH: ${{ github.head_ref }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          REGISTRY_NAME: ${{ secrets.DO_REGISTRY_NAME }}
        run: |
          SANITIZED_BRANCH=$(echo "$BRANCH" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//')
          IMAGE_TAG="pr-${PR_NUMBER}"

          mkdir -p infrastructure/preview-environments

          cat > infrastructure/preview-environments/pr-${PR_NUMBER}.yaml << EOF
          apiVersion: argoproj.io/v1alpha1
          kind: Application
          metadata:
            name: markdown-editor-preview-${SANITIZED_BRANCH}
            namespace: argocd
            labels:
              preview: "true"
              pr-number: "${PR_NUMBER}"
            finalizers:
              - resources-finalizer.argocd.argoproj.io
          spec:
            project: default
            source:
              repoURL: git@github.com:${REPO}.git
              targetRevision: ${BRANCH}
              path: infrastructure/applications/atomsized.com/markdown-editor
              kustomize:
                patches:
                  - target:
                      kind: Ingress
                      name: markdown-editor
                    patch: |
                      - op: replace
                        path: /spec/rules/0/host
                        value: ${SANITIZED_BRANCH}.atomsized.com
                      - op: replace
                        path: /spec/tls/0/hosts/0
                        value: ${SANITIZED_BRANCH}.atomsized.com
                  - target:
                      kind: ConfigMap
                      name: markdown-editor-config
                    patch: |
                      - op: replace
                        path: /data/database-schema
                        value: preview_${BRANCH}
                  - target:
                      kind: Deployment
                      name: markdown-editor
                    patch: |
                      - op: replace
                        path: /spec/template/spec/containers/0/image
                        value: registry.digitalocean.com/${REGISTRY_NAME}/markdown-editor:${IMAGE_TAG}
            destination:
              server: https://kubernetes.default.svc
              namespace: preview-${SANITIZED_BRANCH}
            syncPolicy:
              automated:
                prune: true
                selfHeal: true
              syncOptions:
                - CreateNamespace=true
          EOF

      - name: Commit preview environment config
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add infrastructure/preview-environments/
          git diff --staged --quiet || git commit -m "chore: create preview environment for PR #${{ github.event.pull_request.number }}"
          git push origin HEAD:${{ github.head_ref }}

      - name: Comment on PR
        uses: actions/github-script@v7
        env:
          BRANCH: ${{ github.head_ref }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        with:
          script: |
            const branch = process.env.BRANCH.toLowerCase().replace(/[^a-z0-9-]/g, '-').replace(/--+/g, '-').replace(/^-|-$/g, '');
            const url = `https://${branch}.atomsized.com`;
            const prNumber = process.env.PR_NUMBER;

            const body = [
              '## Preview Environment',
              '',
              'Your preview environment is being deployed:',
              `- **URL:** ${url}`,
              `- **Schema:** \`preview_${process.env.BRANCH}\``,
              `- **Image:** \`pr-${prNumber}\``,
              '',
              'The environment will be ready in a few minutes once ArgoCD syncs.'
            ].join('\n');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
