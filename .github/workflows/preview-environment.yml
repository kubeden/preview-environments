name: Preview Environment

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - "applications/**"

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: preview-${{ github.head_ref }}
  cancel-in-progress: true

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      markdown-editor: ${{ steps.filter.outputs.markdown-editor }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            markdown-editor:
              - 'applications/atomsized/markdown-editor/**'

  build-markdown-editor:
    needs: detect-changes
    if: needs.detect-changes.outputs.markdown-editor == 'true'
    uses: ./.github/workflows/build-and-push.yml
    with:
      app-path: applications/atomsized/markdown-editor
      image-name: markdown-editor
      tag: pr-${{ github.event.pull_request.number }}
    secrets: inherit

  setup-preview-schema:
    needs: detect-changes
    if: needs.detect-changes.outputs.markdown-editor == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install dependencies
        working-directory: applications/atomsized/markdown-editor
        run: npm ci

      - name: Generate migrations
        working-directory: applications/atomsized/markdown-editor
        run: npm run db:generate
        env:
          DATABASE_URL: ${{ secrets.SUPABASE_DATABASE_URL }}

      - name: Create schema and run migrations
        working-directory: applications/atomsized/markdown-editor
        run: npm run db:migrate
        env:
          DATABASE_URL: ${{ secrets.SUPABASE_DATABASE_URL }}
          DATABASE_SCHEMA: preview_${{ github.event.pull_request.number }}

  comment-on-pr:
    needs: [build-markdown-editor, setup-preview-schema]
    runs-on: ubuntu-latest
    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        env:
          BRANCH: ${{ github.head_ref }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        with:
          script: |
            const branch = process.env.BRANCH.toLowerCase().replace(/[^a-z0-9-]/g, '-').replace(/--+/g, '-').replace(/^-|-$/g, '');
            const url = `https://${branch}.atomsized.com`;
            const prNumber = process.env.PR_NUMBER;

            const body = [
              '## Preview Environment',
              '',
              'Your preview environment is being deployed:',
              `- **URL:** ${url}`,
              `- **Schema:** \`preview_${prNumber}\``,
              `- **Image:** \`pr-${prNumber}\``,
              '',
              'The environment will be ready once ArgoCD syncs the ApplicationSet.'
            ].join('\n');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
